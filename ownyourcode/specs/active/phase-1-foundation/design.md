# Technical Design: Project Foundation (Phase 1)

> Generated by OwnYourCode based on your stack, official docs, and production patterns.

## Overview

This phase establishes the foundational architecture for CubeClash: a real-time speedcubing competition platform. We create a monorepo structure with a React frontend and Express + Socket.IO backend, enabling WebSocket-based room management for multiplayer races.

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                      Project Root                           │
│  ┌─────────────────────────┐  ┌──────────────────────────────┐ │
│  │     apps/client/        │  │       apps/server/           │ │
│  │  ┌─────────────────┐    │  │  ┌────────────────────┐      │ │
│  │  │  Vite + React   │    │  │  │ Express +          │      │ │
│  │  │  TypeScript     │◄───┼──┼──┼─►│ Socket.IO          │      │ │
│  │  │  Port: 5173     │    │WS│  │  │  Port: 3000        │      │ │
│  │  └─────────────────┘    │  │  └────────────────────┘      │ │
│  │           │             │  │            │                 │ │
│  │    ┌──────┴──────┐      │  │      ┌─────┴──────┐          │ │
│  │    │ Socket.io   │      │  │      │ Socket.io  │          │ │
│  │    │ client      │      │  │      │ server     │          │ │
│  │    └──────┬──────┘      │  │      └─────┬──────┘          │ │
│  └───────────┼─────────────┘  └────────────┼─────────────────┘ │
│            │                              │                │
│            └────────── create-room ─────────►               │
│            ◄────────── room-created ────────┘               │
│            └────────── join-room ───────────►               │
│            ◄────────── room-joined ─────────┘               │
│            ◄────────── room-not-found ──────┘               │
│            └────────── user-joined ────────────────────────►│
└─────────────────────────────────────────────────────────────┘
```

## Components

| Component | Purpose | New/Modified | Location |
|-----------|---------|--------------|----------|
| `package.json` | Root workspace config | New | `/package.json` |
| `apps/client/` | React + Vite frontend | New | `/apps/client/` |
| `apps/server/` | Express + Socket.IO backend | New | `/apps/server/` |
| `apps/server/src/index.ts` | Server entry point | New | `/apps/server/src/index.ts` |
| `apps/server/src/rooms.ts` | Room state management | New | `/apps/server/src/rooms.ts` |
| `apps/client/src/App.tsx` | Main React component | New | `/apps/client/src/App.tsx` |
| `apps/client/src/socket.ts` | Socket.IO client setup | New | `/apps/client/src/socket.ts` |

## Data Flow

### Room Creation Flow

1. **Client connects** → Socket.IO establishes WebSocket connection
2. **User clicks "Create Room"** → Client emits `create-room` event
3. **Server validates** → Checks room ID uniqueness (generates if needed)
4. **Server creates room** → Adds to `rooms` Map with host tracking
5. **Server joins socket** → `socket.join(roomId)`
6. **Acknowledge** → Server emits `room-created` with room ID

```
Client A (Host)                      Server
   │     connect ────────────────────►│
   │◄────────── connected ────────────│
   │                                  │
   │    create-room ────────────────►│
   │                                  │ rooms.set(roomId, {...})
   │◄────────── room-created ─────────│ socket.join(roomId)
```

### Room Join Flow

1. **User clicks "Join Room"** → Client captures room ID input
2. **Emit `join-room`** → Client sends event with room ID to server
3. **Server validates** → Checks if room exists in `rooms` Map
4. **Room not found?** → Server emits `room-not-found` error
5. **Room exists?** → Server calls `socket.join(roomId)`
6. **Broadcast to room** → Server emits `user-joined` to other sockets
7. **Acknowledge** → Server emits `room-joined` to joining socket

```
Client A (Host)              Server                  Client B (Joiner)
   │◄─────── waiting ───────────│                            │
   │                            │    join-room("room-1") ────►│
   │                            │      (validate room exists)│
   │◄────── user-joined ────────│◄──── socket.join() ────────┤
   │                            │                            │
   │                            │──────── room-joined ──────►│
   │                            │ (OR room-not-found error)  │
```

## State Management

### Client State (React)

| State | Type | Location | Initial Value |
|-------|------|----------|---------------|
| `socket` | Socket.IO client | `apps/client/src/socket.ts` | `null` |
| `connected` | boolean | `apps/client/src/App.tsx` | `false` |
| `roomId` | string | `apps/client/src/App.tsx` | `""` |
| `participants` | string[] | `apps/client/src/App.tsx` | `[]` |
| `error` | string | `apps/client/src/App.tsx` | `""` |
| `isHost` | boolean | `apps/client/src/App.tsx` | `false` |

### Server State (Node.js)

| State | Type | Location | Description |
|-------|------|----------|-------------|
| `rooms` | Map<string, Room> | `apps/server/src/rooms.ts` | Active rooms with metadata |
| `roomId` | string | Socket.IO room | Socket.IO's internal room tracking |

**Room Interface:**
```typescript
interface Room {
  id: string;
  hostId: string;        // socket.id of creator
  createdAt: Date;
  participants: string[]; // socket.ids
}
```

## Error Handling

| Error Type | User Sees | Code Does |
|------------|-----------|-----------|
| Connection failed | "Unable to connect to server" | Retry with exponential backoff |
| Server not running | "Server is offline" | Display error state |
| Room not found | "Room not found. Check the ID and try again." | Server emits `room-not-found`, client shows error |
| Room join failed | "Could not join room" | Log error, allow retry |
| Socket disconnect | "Connection lost" | Attempt reconnection |

## Security Considerations

- [x] CORS configured for development (localhost:5173 → localhost:3000)
- [ ] No sensitive data in localStorage yet (Phase 2 will add user identification)
- [ ] Input sanitization for room IDs (prevent injection)
- [ ] Rate limiting on room joins (future enhancement)

## Patterns from Research

Based on Context7 and Octocode research:

### Socket.IO Server Initialization (Official Pattern)
```typescript
import express from "express";
import { createServer } from "http";
import { Server } from "socket.io";

const app = express();
const httpServer = createServer(app);
const io = new Server(httpServer, { /* options */ });

io.on("connection", (socket) => {
  // Handle connections
});

httpServer.listen(3000);
```

### Room Creation Pattern (Explicit)
```typescript
// Server-side room state
const rooms = new Map<string, Room>();

socket.on("create-room", () => {
  const roomId = generateRoomId(); // e.g., "ABC123"
  rooms.set(roomId, {
    id: roomId,
    hostId: socket.id,
    createdAt: new Date(),
    participants: [socket.id]
  });
  socket.join(roomId);
  socket.emit("room-created", roomId);
});
```

### Room Join Pattern (with Validation)
```typescript
socket.on("join-room", (roomId) => {
  if (!rooms.has(roomId)) {
    socket.emit("room-not-found");
    return;
  }
  
  socket.join(roomId);
  const room = rooms.get(roomId)!;
  room.participants.push(socket.id);
  
  socket.to(roomId).emit("user-joined", socket.id);
  socket.emit("room-joined", roomId);
});
```

### Monorepo Workspace (npm)
```json
{
  "workspaces": ["apps/*"],
  "scripts": {
    "dev": "concurrently \"npm run dev -w apps/server\" \"npm run dev -w apps/client\""
  }
}
```

### Key Learnings from Production Apps

1. **Always use `httpServer.listen()` not `app.listen()`** — Socket.IO requires the HTTP server instance
2. **Explicit room creation** — Track rooms in server state (Map) for validation and metadata
3. **Validate before join** — Check `rooms.has(roomId)` before allowing join, emit error if not found
4. **Socket IDs are unique** — Use `socket.id` for participant identification (temporary, Phase 2 will add nicknames)
5. **Broadcast patterns** — Use `socket.to(room).emit()` to broadcast to others (excluding sender)
6. **TypeScript types** — Define event payloads as interfaces for type safety
7. **Generate room IDs** — Use short, readable IDs (6 chars: "ABC123") instead of UUIDs for easy sharing

## File Structure

```
cubeclash/
├── package.json              # Root workspace config
├── apps/
│   ├── client/
│   │   ├── package.json      # React + Vite deps
│   │   ├── vite.config.ts    # Vite config
│   │   ├── tsconfig.json     # TypeScript config
│   │   ├── index.html        # HTML entry
│   │   └── src/
│   │       ├── main.tsx      # React entry
│   │       ├── App.tsx       # Main app component
│   │       ├── socket.ts     # Socket.IO client
│   │       └── App.css       # Styles
│   └── server/
│       ├── package.json      # Express + Socket.IO deps
│       ├── tsconfig.json     # TypeScript config
│       └── src/
│           ├── index.ts      # Server entry + Socket.IO handlers
│           ├── rooms.ts      # Room state management
│           └── types.ts      # Shared TypeScript interfaces
└── ownyourcode/              # OwnYourCode specs (already exists)
```

## Dependencies

### Root (`package.json`)
- `concurrently` - Run client and server simultaneously

### Client (`apps/client/package.json`)
- `react` ^19.0.0
- `react-dom` ^19.0.0
- `socket.io-client` ^4.8.3
- `typescript` ^5.9.3
- `vite` ^7.0.0
- `@types/react`
- `@types/react-dom`

### Server (`apps/server/package.json`)
- `express` ^5.0.0
- `socket.io` ^4.8.3
- `typescript` ^5.9.3
- `@types/express`
- `@types/node`
- `tsx` or `ts-node` - TypeScript execution

## Environment Variables

| Variable | Default | Purpose |
|----------|---------|---------|
| `PORT` | 3000 | Server port |
| `CLIENT_URL` | http://localhost:5173 | CORS origin |
