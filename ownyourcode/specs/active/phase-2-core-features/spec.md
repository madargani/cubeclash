# Feature: Core Competition Features (Phase 2)

> Generated by OwnYourCode for CubeClash Phase 2.

## User Story

As a speedcuber, I want to join a virtual competition room, receive synchronized scrambles, time my solves with a cstimer-like interface, and see live race results so that I can compete with friends remotely in real-time.

## Acceptance Criteria

When these pass, Phase 2 is DONE:

- [ ] Users see the same WCA-compliant scramble simultaneously when a round starts
- [ ] Users can time their solves using spacebar-to-start (cstimer-style)
- [ ] Users can optionally use a 15-second inspection countdown before solving
- [ ] Users submit their solve times which appear on a live leaderboard
- [ ] Leaderboard updates in real-time for all room members after each submission
- [ ] Host can start and end rounds, initiating new scrambles
- [ ] Users are identified by nickname (not just socket ID)
- [ ] Disconnected users are handled gracefully (marked as offline)

## Edge Cases

| Scenario | Expected Behavior |
|----------|-------------------|
| User joins mid-round | Sees current scramble, can participate in next round |
| User disconnects during solve | Time recorded as DNF, shown as offline on leaderboard |
| Host disconnects | Room continues, new host assigned or room ends |
| Double spacebar press | Prevent accidental double submission |
| Submit before inspection complete | Show warning, allow override |
| Negative time (timer error) | Prevent submission, show error |
| Late submission (after round ended) | Reject submission, show "Round ended" message |
| Same time as another user | Tiebreaker by submission order (first wins) |
| Server scramble generation fails | Retry with fallback, show error if persistent |
| User tries to start timer before scramble shown | Disable until scramble distributed |

> **Junior:** Add any edge cases I missed below:
> - [ ] _Your edge case here_

## Out of Scope

What Phase 2 does NOT include (for future phases):

- Penalty management (+2, DNF marking by users) — Phase 3
- Room settings (cube type, round count) — Phase 3
- Results history / session summary — Phase 3
- Multiple cube types (only 3x3x3) — Phase 3
- Official WCA-style statistics (Ao5, Mo3) — Phase 3
- Spectator mode — Future
- Video verification — Future

## Dependencies

Before starting Phase 2:
- [x] Phase 1 complete (Socket.IO rooms, basic connection)
- [x] Scramble generation library selected (cubing.js)
- [ ] Install cubing.js: `npm install cubing`

## Research References

- Context7: cubing.js library — WCA-compliant random-state scrambles
- cubing.js Usage: `import { randomScrambleForEvent } from "cubing/scramble"`
- WCA Regulation 4b3: Requires random-state scrambles for 3x3x3
- Socket.IO rooms for synchronized state distribution

---

## Feature Breakdown

### 1. User Identification System
Users need nicknames instead of socket IDs for the leaderboard.

**Requirements:**
- Prompt for nickname on room join
- Validate nickname (3-20 chars, alphanumeric + spaces)
- Store nickname server-side with socket ID
- Display nickname on leaderboard

### 2. Scramble Generation & Distribution
Generate and distribute WCA-compliant scrambles to all room members simultaneously.

**Requirements:**
- Use cubing.js `randomScrambleForEvent("333")`
- Server generates scramble when host starts round
- Server broadcasts scramble to all room members
- Clients display scramble prominently
- Scramble persists for the duration of the round

### 3. Timer UI (cstimer-style)
A familiar timing interface for speedcubers.

**Requirements:**
- Large, centered timer display (mm:ss.ms format)
- Spacebar to start/stop (hold 0.3s to start per cstimer)
- Optional 15-second inspection countdown
- Visual indicators: green (ready), red (inspection), white (solving)
- Millisecond precision (performance.now())
- Prevent accidental double-starts

### 4. Solve Submission
Submit completed times to the server.

**Requirements:**
- Submit button (and auto-submit on spacebar stop)
- Send: { time: number in ms, nickname, timestamp }
- Server validates: time > 0, round active
- Server broadcasts to all clients

### 5. Live Leaderboard
Real-time race results visible to all participants.

**Requirements:**
- Sorted by time (fastest first)
- Shows: rank, nickname, time, status (solving, finished, DNF)
- Updates in real-time via Socket.IO
- Highlight current user's row
- Show "waiting" state for users who haven't submitted

### 6. Round Management
Host controls the competition flow.

**Requirements:**
- Host can "Start Round" (generates new scramble)
- Host can "End Round" (stops accepting submissions)
- Round state: waiting → active → ended
- Automatic progression: show results, then ready for next round
- Non-hosts see "Waiting for host..." when appropriate

### 7. Connection Handling
Graceful handling of disconnections.

**Requirements:**
- Detect disconnection (Socket.IO built-in)
- Mark user as "offline" on leaderboard
- DNF any active solve for disconnected user
- Allow reconnection (same nickname, resume participation)
- Clean up empty rooms after timeout

---

## Technical Notes

### Recommended cubing.js Integration
```typescript
import { randomScrambleForEvent } from "cubing/scramble";

// Generate WCA-compliant 3x3x3 scramble
const scramble = await randomScrambleForEvent("333");
const scrambleString = scramble.toString();
// Example: "F' R' F' U2 B D' L' U F R B' R2 F' L2 F2 L2 D2 B R2 L2 F'"
```

### Timer Accuracy
- Use `performance.now()` for sub-millisecond precision
- Avoid `Date.now()` (less precise, affected by system time changes)
- Handle tab switching (visibilitychange API)

### Socket.IO Events (New)
| Event | Direction | Payload | Purpose |
|-------|-----------|---------|---------|
| `user:register` | C → S | `{ nickname }` | Set user nickname |
| `round:start` | C → S | `{}` | Host starts round |
| `scramble:new` | S → C | `{ scramble, roundId }` | New scramble distributed |
| `timer:start` | C → S | `{ timestamp }` | User started timer |
| `timer:stop` | C → S | `{ time }` | User completed solve |
| `solve:submit` | C → S | `{ time }` | Submit final time |
| `leaderboard:update` | S → C | `{ results }` | Updated rankings |
| `round:end` | C → S | `{}` | Host ends round |
| `user:disconnected` | S → C | `{ nickname }` | User went offline |

> **Junior:** Review these specs. Add any edge cases I missed, modify anything that doesn't match your vision, and remove anything out of scope for your implementation.
